import{o as d,c as h,a as s,w as p,v as w,b as _,d as y,t as u,n as m,F as b,r as S,e as C,f as T}from"./vendor.b1d52e22.js";const M=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerpolicy&&(i.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?i.credentials="include":e.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(e){if(e.ep)return;e.ep=!0;const i=n(e);fetch(e.href,i)}};M();const k="https://ptx.transportdata.tw/MOTC/v2",x="$format=JSON";class N{async call(t){const n=k+t+"?"+x,a=new Date().toUTCString(),e=await E("FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF","x-date: "+a);return await(await fetch(n,{headers:new Headers({Authorization:`hmac username="FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF", algorithm="hmac-sha1", headers="x-date", signature="${e}"`,"x-date":a})})).json()}async bus(t){return await this.call("/Bus"+t)}}async function E(o,t){const n=new TextEncoder("utf-8"),a=await window.crypto.subtle.importKey("raw",n.encode(o),{name:"HMAC",hash:{name:"SHA-1"}},!1,["sign","verify"]),e=await window.crypto.subtle.sign("HMAC",a,n.encode(t));new TextDecoder("utf8");const i=new Uint8Array(e);return btoa(String.fromCharCode.apply(null,i))}var D="./assets/bus.7d9f06ba.svg";var A=(o,t)=>{const n=o.__vccOpts||o;for(const[a,e]of t)n[a]=e;return n};const v=new N;let c;const f=new URLSearchParams(window.location.search),P={created(){},mounted(){c=L.map("map",{zoomControl:!1}).setView([25.033964,121.564468],16),L.control.zoom({position:"bottomright"}).addTo(c),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(c),new ResizeObserver(()=>{c.invalidateSize()}).observe(this.$refs.map),c.on("zoomend",()=>{document.querySelectorAll("#map .map-marker-icon-wrapper").forEach(t=>{t.style.fontSize=1/Math.pow(1.2,18-c.getZoom())+"em"})}),this.city!=""&&this.route!=""&&this.displayRoute()},data(){return{city:f.get("city")||"",route:f.get("route")||"",qroute:"",stops:[[],[]],direction:f.get("dir")||0,etaMaps:{0:{},1:{}}}},computed:{destinations(){return this.stops.map(o=>o.length==0?"":o[o.length-1].name)},showRouteBanner(){return this.stops[0].length>0&&this.stops[1].length>0&&this.qroute!=""},layers(){return this.stops.map(I)},currentLayer(){return this.layers[this.direction]}},watch:{currentLayer(o,t){c.removeLayer(t),c.addLayer(o);const n=this.stops[this.direction].length,a=this.stops[this.direction][Math.floor(n/2)].latlng;c.setView(a,16),document.querySelectorAll("#map .map-marker-icon-wrapper").forEach(e=>{e.style.fontSize=1/Math.pow(1.2,18-c.getZoom())+"em"})},direction(){this.updateUrl()}},methods:{panTo(o){c.panTo(o)},updateUrl(){const o=new URL(window.location);let t=!1;this.city&&(o.searchParams.set("city",this.city),t=!0),this.route&&(o.searchParams.set("route",this.route),t=!0),t&&(o.searchParams.set("dir",this.direction),window.history.pushState(null,"",o))},async displayRoute(){this.layers.forEach(t=>c.removeLayer(t)),this.updateUrl();const o=await U(this.city,this.route);this.stops=[F(o[0]),F(o[1])],this.qroute=this.route,this.etaMaps=await q(this.city,this.route)},selectDirection(o){this.direction=o}}},R={0:"\u5373\u5C07\u9032\u7AD9",1:"\u5C1A\u672A\u767C\u8ECA",2:"\u4EA4\u7BA1\u4E0D\u505C\u9760",3:"\u672B\u73ED\u8ECA\u5DF2\u904E",4:"\u4ECA\u65E5\u672A\u71DF\u904B"};async function U(o,t){const n={0:{},1:{}};return(await v.bus(`/StopOfRoute/City/${o}/${t}`)).filter(e=>e.RouteName.Zh_tw==t).forEach(e=>{const i=e.Stops,r=n[e.Direction];for(const l of i)r[l.StopUID]={id:l.StopUID,name:l.StopName.Zh_tw,sequence:parseInt(l.StopSequence),latlng:[l.StopPosition.PositionLat,l.StopPosition.PositionLon]}}),n}async function q(o,t){const n={0:{},1:{}};return(await v.bus(`/EstimatedTimeOfArrival/City/${o}/${t}`)).filter(e=>e.RouteName.Zh_tw==t).forEach(e=>{const i=e.StopUID,r=n[e.Direction];r[i]=z(e)}),n}function z(o){let t=O(o.Estimates);return t!==null||(t=parseInt(o.EstimateTime),!isNaN(t))?g(t):typeof o.NextBusTime!="undefined"?new Date(o.NextBusTime).toTimeString().slice(0,5):R[o.StopStatus]}function O(o){if(o){let t=1/0;for(const n of o){const a=parseInt(n.EstimateTime);!isNaN(a)&&a<t&&(t=a)}return t<1/0?t:null}return null}function F(o){return Object.values(o).sort((t,n)=>t.sequence-n.sequence)}function g(o){const t=Math.floor(o/60),n=o%60;let a="";return t!=0&&(a+=t+"\u5206"),a+=n+"\u79D2",a}function I(o){let t=[];for(const n of o)t.push(L.marker(n.latlng,{icon:new L.DivIcon({className:"map-marker-icon-wrapper",html:`<div class="map-marker-icon">${n.sequence}</div>`})}).bindTooltip(n.name));return L.layerGroup(t)}const B={id:"container"},H=s("div",{id:"header"},[s("h1",{id:"title"},"\u966A\u4F60\u7B49\u516C\u8ECA"),s("img",{id:"header-bus",src:D})],-1),V={id:"main"},K={id:"content"},Z={class:"relative"},j={id:"searchbar"},G=C('<option value="Taipei">\u81FA\u5317\u5E02</option><option value="NewTaipei">\u65B0\u5317\u5E02</option><option value="Taoyuan">\u6843\u5712\u5E02</option><option value="Taichung">\u81FA\u4E2D\u5E02</option><option value="Tainan">\u81FA\u5357\u5E02</option><option value="Kaohsiung">\u9AD8\u96C4\u5E02</option><option value="Keelung">\u57FA\u9686\u5E02</option><option value="Hsinchu">\u65B0\u7AF9\u5E02</option><option value="HsinchuCounty">\u65B0\u7AF9\u7E23</option><option value="MiaoliCounty">\u82D7\u6817\u7E23</option><option value="ChanghuaCounty">\u5F70\u5316\u7E23</option><option value="NantouCounty">\u5357\u6295\u7E23</option><option value="YunlinCounty">\u96F2\u6797\u7E23</option><option value="ChiayiCounty">\u5609\u7FA9\u7E23</option><option value="Chiayi">\u5609\u7FA9\u5E02</option><option value="PingtungCounty">\u5C4F\u6771\u7E23</option><option value="YilanCounty">\u5B9C\u862D\u7E23</option><option value="HualienCounty">\u82B1\u84EE\u7E23</option><option value="TaitungCounty">\u81FA\u6771\u7E23</option><option value="KinmenCounty">\u91D1\u9580\u7E23</option><option value="PenghuCounty">\u6F8E\u6E56\u7E23</option><option value="LienchiangCounty">\u9023\u6C5F\u7E23</option>',22),Y=[G],J=s("div",{id:"search-triangle"},null,-1),X={class:"relative"},Q={id:"banner-container"},W={class:"banner"},$={class:"font-larger",style:{flex:"0.2"}},tt=s("div",{style:{flex:"0.1"}},"\u5F80",-1),et={id:"route-directions"},ot={id:"content-list"},nt=["onClick"],it={class:"serial-no"},st={class:"name"},at={id:"map",ref:"map"};function rt(o,t,n,a,e,i){return d(),h("div",B,[H,s("div",V,[s("div",K,[s("div",Z,[s("div",j,[p(s("select",{name:"city",class:"font-larger bg-yellow searchbar-input",style:{flex:"0.4"},"onUpdate:modelValue":t[0]||(t[0]=r=>e.city=r)},Y,512),[[w,e.city]]),p(s("input",{class:"font-larger bg-yellow searchbar-input",style:{flex:"0.8","min-width":"7em"},type:"text",name:"route",placeholder:"\u516C\u8ECA\u8DEF\u7DDA","onUpdate:modelValue":t[1]||(t[1]=r=>e.route=r)},null,512),[[_,e.route]]),s("button",{class:"font-larger bg-orange searchbar-input",style:{cursor:"pointer"},name:"search",onClick:t[2]||(t[2]=(...r)=>i.displayRoute&&i.displayRoute(...r))}," Go! ")]),J]),s("div",X,[s("div",Q,[p(s("div",W,[s("div",$,u(e.qroute),1),tt,s("div",et,[s("div",{class:m(["destination",e.direction==1?"unselected":""]),onClick:t[3]||(t[3]=r=>i.selectDirection(0))},u(i.destinations[0]),3),s("div",{class:m(["destination",e.direction==0?"unselected":""]),onClick:t[4]||(t[4]=r=>i.selectDirection(1))},u(i.destinations[1]),3)])],512),[[y,i.showRouteBanner]])]),s("div",{id:"banner-triangle",class:m(i.showRouteBanner?"pink":"blue")},null,2)]),s("div",ot,[(d(!0),h(b,null,S(e.stops[e.direction],(r,l)=>(d(),h("div",{class:"item",key:l,onClick:lt=>i.panTo(r.latlng)},[s("div",it,u(l+1),1),s("div",st,u(r.name),1),p(s("div",{class:"time"},u(e.etaMaps[e.direction][r.id]),513),[[y,e.etaMaps[e.direction][r.id]]])],8,nt))),128))])]),s("div",at,null,512)])])}var ct=A(P,[["render",rt]]);T(ct).mount("#app");
