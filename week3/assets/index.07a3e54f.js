import{o as d,c as h,a as s,w as p,v as _,b,d as v,t as u,n as m,F as S,r as C,e as T,f as M}from"./vendor.b1d52e22.js";const E=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))a(e);new MutationObserver(e=>{for(const i of e)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function n(e){const i={};return e.integrity&&(i.integrity=e.integrity),e.referrerpolicy&&(i.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?i.credentials="include":e.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(e){if(e.ep)return;e.ep=!0;const i=n(e);fetch(e.href,i)}};E();const k="https://ptx.transportdata.tw/MOTC/v2",x="$format=JSON";class N{async call(t){const n=k+t+"?"+x,a=new Date().toUTCString(),e=await D("FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF","x-date: "+a);return await(await fetch(n,{headers:new Headers({Authorization:`hmac username="FFFFFFFF-FFFF-FFFF-FFFF-FFFFFFFFFFFF", algorithm="hmac-sha1", headers="x-date", signature="${e}"`,"x-date":a})})).json()}async bus(t){return await this.call("/Bus"+t)}}async function D(o,t){const n=new TextEncoder("utf-8"),a=await window.crypto.subtle.importKey("raw",n.encode(o),{name:"HMAC",hash:{name:"SHA-1"}},!1,["sign","verify"]),e=await window.crypto.subtle.sign("HMAC",a,n.encode(t));new TextDecoder("utf8");const i=new Uint8Array(e);return btoa(String.fromCharCode.apply(null,i))}var A="./assets/bus.7d9f06ba.svg";var P=(o,t)=>{const n=o.__vccOpts||o;for(const[a,e]of t)n[a]=e;return n};const g=new N;let l;const f=new URLSearchParams(window.location.search);let y=null;const R={created(){},mounted(){l=L.map("map",{zoomControl:!1}).setView([25.033964,121.564468],16),L.control.zoom({position:"bottomright"}).addTo(l),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(l),new ResizeObserver(()=>{l.invalidateSize()}).observe(this.$refs.map),l.on("zoomend",()=>{document.querySelectorAll("#map .map-marker-icon-wrapper").forEach(t=>{t.style.fontSize=1/Math.pow(1.15,18-l.getZoom())+"em"})}),this.city!=""&&this.route!=""&&this.displayRoute()},data(){return{city:f.get("city")||"",route:f.get("route")||"",qroute:"",stops:[[],[]],direction:f.get("dir")||0,etaMaps:{0:{},1:{}}}},computed:{destinations(){return this.stops.map(o=>o.length==0?"":o[o.length-1].name)},showRouteBanner(){return this.stops[0].length>0&&this.stops[1].length>0&&this.qroute!=""},layers(){return this.stops.map(B)},currentLayer(){return this.layers[this.direction]}},watch:{currentLayer(o,t){l.removeLayer(t),l.addLayer(o);const n=this.stops[this.direction].length,a=this.stops[this.direction][Math.floor(n/2)].latlng;l.setView(a,14),document.querySelectorAll("#map .map-marker-icon-wrapper").forEach(e=>{e.style.fontSize=1/Math.pow(1.2,18-l.getZoom())+"em"})},direction(){this.updateUrl()}},methods:{panTo(o){l.panTo(o)},updateUrl(){const o=new URL(window.location);let t=!1;this.city&&(o.searchParams.set("city",this.city),t=!0),this.route&&(o.searchParams.set("route",this.route),t=!0),t&&(o.searchParams.set("dir",this.direction),window.history.pushState(null,"",o))},async displayRoute(){y!==null&&clearTimeout(y),this.layers.forEach(t=>l.removeLayer(t)),this.updateUrl();const o=await q(this.city,this.route);this.stops=[F(o[0]),F(o[1])],this.qroute=this.route,this.direction=0,typeof this.stops[0]!="undefined"&&this.stops[0].length>0&&typeof this.stops[1]!="undefined"&&this.stops[1].length>0&&this.updateEta()},async updateEta(){this.etaMaps=await z(this.city,this.route),y=setTimeout(this.updateEta,6e4)},selectDirection(o){this.direction=o}}},U={0:"\u5373\u5C07\u9032\u7AD9",1:"\u5C1A\u672A\u767C\u8ECA",2:"\u4EA4\u7BA1\u4E0D\u505C\u9760",3:"\u672B\u73ED\u8ECA\u5DF2\u904E",4:"\u4ECA\u65E5\u672A\u71DF\u904B"};async function q(o,t){const n={0:{},1:{}};return(await g.bus(`/StopOfRoute/City/${o}/${t}`)).filter(e=>e.RouteName.Zh_tw==t).forEach(e=>{const i=e.Stops,r=n[e.Direction];for(const c of i)r[c.StopUID]={id:c.StopUID,name:c.StopName.Zh_tw,sequence:parseInt(c.StopSequence),latlng:[c.StopPosition.PositionLat,c.StopPosition.PositionLon]}}),n}async function z(o,t){const n={0:{},1:{}};return(await g.bus(`/EstimatedTimeOfArrival/City/${o}/${t}`)).filter(e=>e.RouteName.Zh_tw==t).forEach(e=>{const i=e.StopUID,r=n[e.Direction];r[i]=O(e)}),n}function O(o){let t=I(o.Estimates);return t!==null||(t=parseInt(o.EstimateTime),!isNaN(t))?w(t):typeof o.NextBusTime!="undefined"?new Date(o.NextBusTime).toTimeString().slice(0,5).replace(":","\u9EDE")+"\u5206\u5230\u7AD9":U[o.StopStatus]}function I(o){if(o){let t=1/0;for(const n of o){const a=parseInt(n.EstimateTime);!isNaN(a)&&a<t&&(t=a)}return t<1/0?t:null}return null}function F(o){return Object.values(o).sort((t,n)=>t.sequence-n.sequence)}function w(o){const t=Math.floor(o/60),n=o%60;let a="";return t!=0&&(a+=t+"\u5206"),n!=0&&(a+=n+"\u79D2"),a||"0\u79D2"}function B(o){let t=[];for(const n of o)t.push(L.marker(n.latlng,{icon:new L.DivIcon({className:"map-marker-icon-wrapper",html:`<div class="map-marker-icon"><span class="map-marker-icon-text">${n.sequence}</span></div>`})}).bindTooltip(n.name));return L.layerGroup(t)}const H={id:"container"},V=s("div",{id:"header"},[s("h1",{id:"title"},"\u966A\u4F60\u7B49\u516C\u8ECA"),s("img",{id:"header-bus",src:A})],-1),K={id:"main"},Z={id:"content"},j={class:"relative"},G={id:"searchbar"},Y=T('<option value="Taipei">\u81FA\u5317\u5E02</option><option value="NewTaipei">\u65B0\u5317\u5E02</option><option value="Taoyuan">\u6843\u5712\u5E02</option><option value="Taichung">\u81FA\u4E2D\u5E02</option><option value="Tainan">\u81FA\u5357\u5E02</option><option value="Kaohsiung">\u9AD8\u96C4\u5E02</option><option value="Keelung">\u57FA\u9686\u5E02</option><option value="Hsinchu">\u65B0\u7AF9\u5E02</option><option value="HsinchuCounty">\u65B0\u7AF9\u7E23</option><option value="MiaoliCounty">\u82D7\u6817\u7E23</option><option value="ChanghuaCounty">\u5F70\u5316\u7E23</option><option value="NantouCounty">\u5357\u6295\u7E23</option><option value="YunlinCounty">\u96F2\u6797\u7E23</option><option value="ChiayiCounty">\u5609\u7FA9\u7E23</option><option value="Chiayi">\u5609\u7FA9\u5E02</option><option value="PingtungCounty">\u5C4F\u6771\u7E23</option><option value="YilanCounty">\u5B9C\u862D\u7E23</option><option value="HualienCounty">\u82B1\u84EE\u7E23</option><option value="TaitungCounty">\u81FA\u6771\u7E23</option><option value="KinmenCounty">\u91D1\u9580\u7E23</option><option value="PenghuCounty">\u6F8E\u6E56\u7E23</option><option value="LienchiangCounty">\u9023\u6C5F\u7E23</option>',22),J=[Y],X=s("div",{id:"search-triangle"},null,-1),Q={class:"relative"},W={id:"banner-container"},$={class:"banner"},tt={class:"font-larger",style:{flex:"0.2"}},et=s("div",{style:{flex:"0.1"}},"\u5F80",-1),ot={id:"route-directions"},nt={id:"content-list"},it=["onClick"],st={class:"serial-no"},at={class:"name"},rt={id:"map",ref:"map"};function lt(o,t,n,a,e,i){return d(),h("div",H,[V,s("div",K,[s("div",Z,[s("div",j,[s("div",G,[p(s("select",{name:"city",class:"font-larger bg-yellow searchbar-input",style:{flex:"0.4"},"onUpdate:modelValue":t[0]||(t[0]=r=>e.city=r)},J,512),[[_,e.city]]),p(s("input",{class:"font-larger bg-yellow searchbar-input",style:{flex:"0.8","min-width":"7em"},type:"text",name:"route",placeholder:"\u516C\u8ECA\u8DEF\u7DDA","onUpdate:modelValue":t[1]||(t[1]=r=>e.route=r)},null,512),[[b,e.route]]),s("button",{class:"font-larger bg-orange searchbar-input",style:{cursor:"pointer"},name:"search",onClick:t[2]||(t[2]=(...r)=>i.displayRoute&&i.displayRoute(...r))}," Go! ")]),X]),s("div",Q,[s("div",W,[p(s("div",$,[s("div",tt,u(e.qroute),1),et,s("div",ot,[s("div",{class:m(["destination",e.direction==1?"unselected":""]),onClick:t[3]||(t[3]=r=>i.selectDirection(0))},u(i.destinations[0]),3),s("div",{class:m(["destination",e.direction==0?"unselected":""]),onClick:t[4]||(t[4]=r=>i.selectDirection(1))},u(i.destinations[1]),3)])],512),[[v,i.showRouteBanner]])]),s("div",{id:"banner-triangle",class:m(i.showRouteBanner?"pink":"blue")},null,2)]),s("div",nt,[(d(!0),h(S,null,C(e.stops[e.direction],(r,c)=>(d(),h("div",{class:"item",key:c,onClick:ut=>i.panTo(r.latlng)},[s("div",st,u(c+1),1),s("div",at,u(r.name),1),p(s("div",{class:"time"},u(e.etaMaps[e.direction][r.id]),513),[[v,e.etaMaps[e.direction][r.id]]])],8,it))),128))])]),s("div",rt,null,512)])])}var ct=P(R,[["render",lt]]);M(ct).mount("#app");
